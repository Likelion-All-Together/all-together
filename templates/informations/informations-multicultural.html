{% extends 'base.html' %}
{% block title %}다문화 일자리 정보 페이지{% endblock %}
{% load static %}
{% block content %}

<head>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
</head>

<!-- 최신순/스크랩순 정렬 jquery-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function(){
        $("select[name=align_mode]").change(function () {
            $("#align_mode_form").submit();
        });
        var align_mode = "{{ request.GET.align_mode }}";  // Django 템플릿 태그로 파라미터 값 가져오기
        if(align_mode === 'recently') { $("#align_mode option[value='recently']").prop("selected", true); }
        else if (align_mode === 'scrap') { $("#align_mode option[value='scrap']").prop("selected", true); } 
        else { $("#align_mode option[value='recently']").prop("selected", true); }
    });
</script>

<br>
<hr>
<li><a href = "{% url 'informations:region' %}">지역 복지</a></li>
<li><a href = "{% url 'informations:multicultural' %}">다문화 일자리</a></li>
<li><a href = "{% url 'informations:afterschool' %}">방과후 수업</a></li>
<br>

<h3>다문화</h3>

<form action="{% url 'informations:multicultural' %}" method="GET" id="align_mode_form">
    <select name="align_mode" id="align_mode">
        <option value="recently">최신순</option>
        <option value="scrap">스크랩순</option>
    </select>
</form>

<div id="item-container">
    {% for item in item_list %}
        <div class="item">
            제목 : {{ item.title }}<br>
            내용 : {{ item.content }}<br>
            문의처 : {{ item.phone }}<br>
            지원 주기 : {{ item.support_cycle }}<br>
            제공 유형 : {{ item.type }}<br>
            담당 부서 : {{ item.department }}<br>
            태그 : {{ item.tag }}<br>
            <button id="scrap-btn-{{ item.id }}" onclick="item_scrap({{ item.id }})">
                {% if request.user in item.scrap.all %}
                <!-- 로그인 한 유저가 좋아요를 누른 유저일때  -->
                <i id="heart-{{ item.id }}" class="fas fa-heart"></i>
                {%else%}
                <!-- 로그인 한 유저가 좋아요를 누른 유저가 아닐 때  -->
                <i id="heart-{{ item.id }}" class="far fa-heart"></i>
                {%endif%}
                <span class="scrap-count" id="scrap_count-{{ item.id }}">{{ item.scrap.count }}</span>
            </button>

            <br>
            <br>
        </div>
    {% endfor %}
</div>

<script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
<script type="text/javascript">
    function item_scrap(id) {
        console.log("hi")
        $.ajax({
            url: "{%url 'informations:scrap'%}", // data를 전송할 url 입니다.
            type: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
            },
            data: {
                'item_id': id,
                'item_name': '다문화',
            }, // post_id 라는 name으로 id 값 전송
            dataType: "json",
            success: function (response) { // ajax 통신이 정상적으로 완료되었을 때
                // $('#scrap_count-' + id).html(response.scrap_count);
                // $('#message').html(response.message);
                // if (response.message === "좋아요") {
                //     $('#heart-' + id).attr("class", "fas fa-heart");
                // } else if (response.message === "좋아요 취소") {
                //     $('#heart-' + id).attr("class", "far fa-heart");
                // }

                $('#scrap_count-' + id).html(response.scrap_count);
                $('#message').html(response.message);
                
                // 해당 항목의 좋아요 수만 업데이트
                $('#scrap_count-' + id).html(response.scrap_count);
                
                // 좋아요 버튼 아이콘 변경
                var heartIcon = $('#heart-' + id);
                if (response.message === "좋아요") {
                    heartIcon.removeClass("far fa-heart").addClass("fas fa-heart");
                } else if (response.message === "좋아요 취소") {
                    heartIcon.removeClass("fas fa-heart").addClass("far fa-heart");
                }
                
                // 좋아요 수에 따라 항목을 정렬 (jQuery 이용)
                var itemContainer = $('#item-container');  // 항목을 감싸는 컨테이너의 ID
                var alignMode = $('#align_mode').val(); // 선택된 정렬 모드 가져오기
    
                if (alignMode === 'scrap') {
                    var items = itemContainer.children('.item');  // 항목들을 선택
        
                    items.sort(function(a, b) {
                        var aScrapCount = parseInt($(a).find('.scrap-count').text());
                        var bScrapCount = parseInt($(b).find('.scrap-count').text());
                        return bScrapCount - aScrapCount;  // 내림차순 정렬
                    });
                    
                    itemContainer.html(items);  // 정렬된 항목을 컨테이너에 적용
                }
            }
        });
    }
</script>

{% endblock %}